<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Using MCTS to Beat FunSearch | Andrew's Blog</title> <meta name="author" content="abc b c"/> <meta name="description" content="Instead of using a genetic algorithm, we experiment with incorporating MCTS"/> <meta name="keywords" content="machine-learning, ml, deep-learning, reinforcement-learning, iclr"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://andrewwangva.github.io/blog/2024/FunMCTSearch/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <d-front-matter> <script async type="text/json">{
      "title": "Using MCTS to Beat FunSearch",
      "description": "Instead of using a genetic algorithm, we experiment with incorporating MCTS",
      "published": "April 21, 2024",
      "authors": [
        {
          "author": "Andrew Wang",
          "authorURL": "",
          "affiliations": [
            {
              "name": "MIT",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <body class="fixed-top-nav"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Andrew's Blog</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/blog/index.html">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/_pages/dropdown/">more</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>Using MCTS to Beat FunSearch</h1> <p>Instead of using a genetic algorithm, we experiment with incorporating MCTS</p> </d-title> <d-byline></d-byline> <d-article> <h1 id="previous-work">Previous Work</h1> <p>Deepmind introduced <a href="https://deepmind.google/discover/blog/funsearch-making-new-discoveries-in-mathematical-sciences-using-large-language-models/">FunSearch</a> [1], a paper that provided a unique way to generate programs that solved optimization problems. They were able to find improvements in practice to algorithmic combinatorial problems such as the Cap set problem or online bin packing. The programs generated were largely heuristic based, but due to their complexity, was able to beat out traditional heuristics created. The paper introduced an interesting idea of using LLM’s as a mutator in a genetic algorithm setup. The authors would repeatedly generate new programs by combining previous ones, creating hybrids and increasing variation. Similar ideas were built on top of the idea of using LLMs as a policy from Deepmind including AlphaGeometry.</p> <p>Some of the results from FunSearch seemed pretty impressive, beating the state of the art methods in Cap Set and the online bin-packing problem. In this work, we chose to mainly focus on the online bin-packing problem. The problem involves sequentially placing items of varying sizes into bins with a fixed capacity in real-time, aiming to minimize the number of bins used without knowing future items. To follow FunSearch’s format of the problem, we mutate a function <code class="language-plaintext highlighter-rouge">priority</code> which assigns a priority to each bin given an item that is then sorted into the highest priority bin:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">bins</span> <span class="o">-</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div></div> <p>Unfortunately, it doesn’t seem that many in the academic community have been working on improving upon this work outside of Deepmind. The results achieved, specifically in the bin-packing problem requires up to scales of 10^6 LLM calls along with multiple runs. We introduce a new method, based around MCTS in finding heuristic programs given an evaluation function that is competitive at a much smaller scale.</p> <h1 id="incorporating-mcts">Incorporating MCTS</h1> <p>MCTS has widely been used in AI systems for games. The idea is to use a policy to narrow down moves to search over and then to evaluate the downstream nodes by simulation and a value function. The core of the MCTS algorithm consists of four distinct steps: Selection, Expansion, Simulation, and Backpropagation. These steps are repeated iteratively to build a search tree.</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MCTS/MCTS_figure-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MCTS/MCTS_figure-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MCTS/MCTS_figure-1400.webp"/> <img src="/assets/img/MCTS/MCTS_figure.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture><figcaption class="caption">Figure taken from the AlphaGo paper. Credit: Silver et al. [2]</figcaption> </figure> <p>In this section, we’ll briefly describe how we combined LLM outputs with MCTS. We use the LLM as a policy, prompting it with an existing solution and asking it to modify it slightly. We use the <a href="https://people.brunel.ac.uk/~mastjjb/jeb/orlib/binpackinfo.html">OR dataset</a> as in FunSearch, we optimize against OR1 and treat OR2-OR4 as our test set.</p> <h3 id="1-selection">1. Selection</h3> <p>In each iteration, we choose a node to expand by traversing a tree and choosing the child with the largest Upper Confidence Bound (UCB). The UCB for a node is calculated as follows:</p> \[UCB(s, a) = U(s, a) + Q(s, a)\] \[U(s, a) = \frac{V(s)}{1 + N}\] \[Q(s, a) = \sum_{s'}^{\text{simulated nodes}} \frac{V(s')}{N}\] <p>Where:</p> <ul> <li><code class="language-plaintext highlighter-rouge">V(s)</code> is the value of the program evaluated against our bin packing dataset.</li> <li><code class="language-plaintext highlighter-rouge">N</code> is the number of times we’ve visited or simulated a node in the subtree.</li> </ul> <p>This UCB score serves as a way to tradeoff between exploration and exploitation, both increasing the breadth of our tree along with the depth when we find a strong path.</p> <h3 id="2-expansion">2. Expansion</h3> <p>Expansion is performed using the Large Language Model (LLM) as a policy to generate a few candidate actions. We prompt the LLM to take the existing solution from the current node and modify it slightly to improve results.</p> <h3 id="3-simulation">3. Simulation</h3> <p>Simulation involves using a smaller LLM as our fast rollout policy. We go through multiple rounds of modifying our code slightly as a lookahead into what it may look like after a series of modifications. In our experiments, we use CodeLlama-7b as our smaller, weaker model and GPT-3 as our larger, stronger model. We then update our values for the visit number along with our simulation score for each node in the path.</p> <h1 id="results">Results</h1> <p>First we ran an experiment comparing it to simpler search methods. We compare it to methods that repeatedly applies the improvement prompt. We also consider a simple tree where we build out a tree where each node has two children.</p> <div style="display: flex; justify-content: space-between;"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MCTS/chain-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MCTS/chain-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MCTS/chain-1400.webp"/> <img src="/assets/img/MCTS/chain.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture><figcaption class="caption">Self-improvement Chain</figcaption> </figure> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MCTS/binary_tree-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MCTS/binary_tree-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MCTS/binary_tree-1400.webp"/> <img src="/assets/img/MCTS/binary_tree.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture><figcaption class="caption">Self-improvement Binary Tree</figcaption> </figure> </div> <p>Below, we show MCTS outpeforms FunSearch when using a comparable amount of LLM calls from the genetic algorithm and is competitive with the best results Deepmind had at a much smaller scale.</p> <table> <thead> <tr> <th>Methods using 1000 LLM Calls</th> <th>OR1</th> <th>OR2</th> <th>OR3</th> <th>OR4</th> </tr> </thead> <tbody> <tr> <td>Zero-shot prompting 1000 times</td> <td>51.9</td> <td>107.7</td> <td>212.0</td> <td>420.35</td> </tr> <tr> <td>10 x Self-improvement Chain depth 100</td> <td>51.85</td> <td>107.7</td> <td>212.0</td> <td>420.35</td> </tr> <tr> <td>Binary tree with 1000 nodes</td> <td>51.8</td> <td>107.7</td> <td>212.0</td> <td>420.3</td> </tr> <tr> <td>FunSearch with 1000 API Calls</td> <td>51.75</td> <td>107.3</td> <td>211.2</td> <td>418.45</td> </tr> <tr> <td>MCTS with 1000 API Calls</td> <td><strong>51.6</strong></td> <td><strong>106.0</strong></td> <td><strong>207.95</strong></td> <td><strong>410.85</strong></td> </tr> </tbody> </table> <table> <thead> <tr> <th>Method</th> <th>OR1</th> <th>OR2</th> <th>OR3</th> <th>OR4</th> </tr> </thead> <tbody> <tr> <td>MCTS with 1000 API Calls</td> <td><strong>51.6</strong></td> <td>106.0</td> <td>207.95</td> <td>410.85</td> </tr> <tr> <td>Reported FunSearch with 10^6 LLM Calls</td> <td>51.64</td> <td><strong>105.8</strong></td> <td><strong>207.46</strong></td> <td><strong>410.44</strong></td> </tr> </tbody> </table> <p>Our method finds a better solution for the dataset it’s optimizing, OR1, but does not generalize as well - an issue that could be due to lack of hyperparameter tuning along with lacking multiple runs as FunSearch was done. We show below how our solution improves with more iterations of MCTS:</p> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MCTS/MCTS_Graph-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MCTS/MCTS_Graph-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MCTS/MCTS_Graph-1400.webp"/> <img src="/assets/img/MCTS/MCTS_Graph.png" class="img-fluid" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <p>Here’s the program our method found after 100 iterations of MCTS if you wanted it to test it out yourself:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">priority_scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">priority_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">item</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">item</span>
        <span class="k">elif</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">priority_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">item</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">priority_scores</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="sh">'</span><span class="s">-inf</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">priority_scores</span>
</code></pre></div></div> <h1 id="conclusion-and-limitations">Conclusion and Limitations</h1> <p>Given the limitation in resources, I’d like to scale this method - I believe it won’t take much scaling to beat FunSearch completely. Additionally, MCTS is highly parallelizable, so having access to a strong model with batch inference would greatly improve our results.</p> <p>Additionally, there are many ways to incorporate MCTS: using an actor-critic setup to transform the problem into a two-player game or performing search on the token-level instead. We chose the simplest setup, which still proved to be quite effective.</p> <p>In a broader scope, I hope more work is done on scaling on the dimension of inference time. As model and dataset sizes increase, an easy way to squeeze improvements in reasoning tasks with Language Model would be to use search. In many areas where we have a fast and accurate evaluation function, using search was the key to gaining strong results.</p> <h3 id="references">References:</h3> <p>1.Romera-Paredes, B., Barekatain, M., Novikov, A. et al. Mathematical discoveries from program search with large language models. Nature 625, 468–475 (2024).</p> <p>2.Silver, D., Schrittwieser, J., Simonyan, K. et al. Mastering the game of Go without human knowledge. Nature 550, 354–359 (2017).</p> <p>3.Trinh, T.H., Wu, Y., Le, Q.V. et al. Solving olympiad geometry without human demonstrations. Nature 625, 476–482 (2024).</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> </div> <d-bibliography src="/assets/bibliography/"></d-bibliography> <script src="https://utteranc.es/client.js" repo="iclr-blogposts/2023" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> </body> </html>